<div align="center">

# å¤šå®ä¾‹ ComfyUI Dockerï¼šå¯æ‰©å±•çš„ AI å›¾åƒç”Ÿæˆå¹³å°

[![GitHub Repo](https://img.shields.io/badge/github-repo-green?logo=github)](https://github.com/ashleykleynhans/comfyui-docker)
[![Docker Image Version (latest semver)](https://img.shields.io/docker/v/ashleykza/comfyui?logo=docker&label=dockerhub&color=blue)](https://hub.docker.com/repository/docker/ashleykza/comfyui)
[![RunPod.io Template](https://img.shields.io/badge/runpod_template-deploy-9b4ce6?logo=linuxcontainers&logoColor=9b4ce6)](https://runpod.io/console/deploy?template=9eqyhd7vs0&ref=2xxro4sy)
<br>
![Docker Pulls](https://img.shields.io/docker/pulls/ashleykza/comfyui?style=for-the-badge&logo=docker&label=Docker%20Pulls&link=https%3A%2F%2Fhub.docker.com%2Frepository%2Fdocker%2Fashleykza%2Fcomfyui%2Fgeneral)
![Template Version](https://img.shields.io/github/v/tag/ashleykleynhans/comfyui-docker?style=for-the-badge&logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDI2LjUuMywgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkxheWVyXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IgoJIHZpZXdCb3g9IjAgMCAyMDAwIDIwMDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDIwMDAgMjAwMDsiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgoJLnN0MHtmaWxsOiM2NzNBQjc7fQo8L3N0eWxlPgo8Zz4KCTxnPgoJCTxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xMDE3Ljk1LDcxMS4wNGMtNC4yMiwyLjM2LTkuMTgsMy4wMS0xMy44NiwxLjgyTDM4Ni4xNyw1NTUuM2MtNDEuNzItMTAuNzYtODYuMDItMC42My0xMTYuNiwyOS43MwoJCQlsLTEuNCwxLjM5Yy0zNS45MiwzNS42NS0yNy41NSw5NS44LDE2Ljc0LDEyMC4zbDU4NC4zMiwzMjQuMjNjMzEuMzYsMTcuNCw1MC44Miw1MC40NSw1MC44Miw4Ni4zMnY4MDYuNzYKCQkJYzAsMzUuNDktMzguNDEsNTcuNjctNjkuMTUsMzkuOTRsLTcwMy4xNS00MDUuNjRjLTIzLjYtMTMuNjEtMzguMTMtMzguNzgtMzguMTMtNjYuMDJWNjY2LjYzYzAtODcuMjQsNDYuNDUtMTY3Ljg5LDEyMS45Mi0yMTEuNjYKCQkJTDkzMy44NSw0Mi4xNWMyMy40OC0xMy44LDUxLjQ3LTE3LjcsNzcuODMtMTAuODRsNzQ1LjcxLDE5NC4xYzMxLjUzLDguMjEsMzYuOTksNTAuNjUsOC41Niw2Ni41N0wxMDE3Ljk1LDcxMS4wNHoiLz4KCQk8cGF0aCBjbGFzcz0ic3QwIiBkPSJNMTUyNy43NSw1MzYuMzhsMTI4Ljg5LTc5LjYzbDE4OS45MiwxMDkuMTdjMjcuMjQsMTUuNjYsNDMuOTcsNDQuNzMsNDMuODIsNzYuMTVsLTQsODU3LjYKCQkJYy0wLjExLDI0LjM5LTEzLjE1LDQ2Ljg5LTM0LjI1LDU5LjExbC03MDEuNzUsNDA2LjYxYy0zMi4zLDE4LjcxLTcyLjc0LTQuNTktNzIuNzQtNDEuOTJ2LTc5Ny40MwoJCQljMC0zOC45OCwyMS4wNi03NC45MSw1NS4wNy05My45Nmw1OTAuMTctMzMwLjUzYzE4LjIzLTEwLjIxLDE4LjY1LTM2LjMsMC43NS00Ny4wOUwxNTI3Ljc1LDUzNi4zOHoiLz4KCQk8cGF0aCBjbGFzcz0ic3QwIiBkPSJNMTUyNC4wMSw2NjUuOTEiLz4KCTwvZz4KPC9nPgo8L3N2Zz4K&logoColor=%23ffffff&label=Template%20Version&color=%23673ab7)

**è¯­è¨€é€‰æ‹© | Language:** [English](README.md) | [ä¸­æ–‡](README_zh.md)

</div>

## ğŸ“‘ ç›®å½•

- [ğŸš€ æ ¸å¿ƒç‰¹æ€§](#-æ ¸å¿ƒç‰¹æ€§)
- [ğŸ—ï¸ ç³»ç»Ÿæ¶æ„](#ï¸-ç³»ç»Ÿæ¶æ„)
- [ğŸ“ ç›®å½•ç»“æ„](#-ç›®å½•ç»“æ„)
- [ğŸ’» å®‰è£…ç»„ä»¶](#-å®‰è£…ç»„ä»¶)
- [ğŸŒ åœ¨ RunPod ä¸Šä½¿ç”¨](#-åœ¨-runpod-ä¸Šä½¿ç”¨)
- [ğŸ› ï¸ æ„å»º Docker é•œåƒ](#ï¸-æ„å»º-docker-é•œåƒ)
- [ğŸš€ æœ¬åœ°è¿è¡Œ](#-æœ¬åœ°è¿è¡Œ)
- [ğŸ”Œ ç«¯å£](#-ç«¯å£)
- [ğŸ›ï¸ ç¯å¢ƒå˜é‡](#ï¸-ç¯å¢ƒå˜é‡)
- [ğŸ”Œ å¤–éƒ¨ API ä½¿ç”¨](#-å¤–éƒ¨-api-ä½¿ç”¨)
- [âš™ï¸ å¤šå®ä¾‹é…ç½®](#ï¸-å¤šå®ä¾‹é…ç½®)
- [ğŸ”§ å¤–éƒ¨ API é›†æˆç¤ºä¾‹](#-å¤–éƒ¨-api-é›†æˆç¤ºä¾‹)
- [ğŸ¤– FaceFusion é›†æˆ](#-facefusion-é›†æˆ)
- [ğŸ“Š æ—¥å¿—](#-æ—¥å¿—)
- [ğŸ§  æ™ºèƒ½ç¯å¢ƒç®¡ç†ç³»ç»Ÿ](#-æ™ºèƒ½ç¯å¢ƒç®¡ç†ç³»ç»Ÿ)
- [ğŸ’¡ æ­¤æ¶æ„çš„ä¼˜åŠ¿](#-æ­¤æ¶æ„çš„ä¼˜åŠ¿)
- [ğŸ› æ•…éšœæ’é™¤](#-æ•…éšœæ’é™¤)
- [ğŸ¤ ç¤¾åŒºå’Œè´¡çŒ®](#-ç¤¾åŒºå’Œè´¡çŒ®)

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **å¤šå®ä¾‹æ”¯æŒ**ï¼šåœ¨å•å°æœºå™¨ä¸Šè¿è¡Œå¤šä¸ªä¸åŒé…ç½®çš„ ComfyUI å®ä¾‹
- **æ™ºèƒ½ç¯å¢ƒç®¡ç†**ï¼šä½¿ç”¨æ„å»ºè„šæœ¬å¤åˆ¶å’ŒåŠ¨æ€è·¯å¾„æ›¿æ¢çš„æŒ‰éœ€æ™ºèƒ½å®‰è£…
- **å¤šå·¥ä½œæµæ„å»ºæ”¯æŒ**ï¼šé€šè¿‡ ARG å‚æ•°é…ç½®æ„å»ºä¸åŒå·¥ä½œæµç‰¹å®šçš„é•œåƒï¼ˆcommã€aua-spï¼‰
- **å…±äº«æ¨¡å‹æ¶æ„**ï¼šæ‰€æœ‰å®ä¾‹å…±äº«ç›¸åŒçš„æ¨¡å‹æ–‡ä»¶ï¼Œå¤§å¹…å‡å°‘ç£ç›˜ä½¿ç”¨
- **å¤–éƒ¨ API æ§åˆ¶**ï¼šé€šè¿‡ RESTful API è°ƒç”¨å¯åŠ¨ã€åœæ­¢å’Œç®¡ç†å®ä¾‹
- **ç¯å¢ƒéš”ç¦»**ï¼šæ¯ä¸ªç¯å¢ƒåœ¨ç‹¬ç«‹ç›®å½•ä¸­è¿è¡Œï¼Œæ‹¥æœ‰ä¸“ç”¨çš„è™šæ‹Ÿç¯å¢ƒ
- **èµ„æºé«˜æ•ˆ**ï¼šé»˜è®¤ä¸è¿è¡Œä»»ä½• ComfyUI å®ä¾‹ï¼Œä»…å¯åŠ¨ FastAPI æœåŠ¡è¿›è¡Œå¤–éƒ¨æ§åˆ¶
- **æ„å»ºè„šæœ¬å¤åˆ¶**ï¼šåˆ›æ–°çš„æ„å»ºè„šæœ¬å¤åˆ¶å’Œè·¯å¾„ä¿®æ”¹æŠ€æœ¯ï¼Œç”¨äºç¯å¢ƒç‰¹å®šå®‰è£…

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ„å»ºæ—¶ vs è¿è¡Œæ—¶æ¶æ„

```mermaid
graph TB
    subgraph "æ„å»ºæ—¶"
        A1["Dockerfile ARG WORKFLOW"] --> A2["å¤åˆ¶ build/WORKFLOW/*"]
        A2 --> A3["å®‰è£…å·¥ä½œæµç‰¹å®šçš„ ComfyUI åˆ° /ComfyUI"]
        A3 --> A4["åˆ›å»ºåŒ…å«é€‰å®šå·¥ä½œæµçš„åŸºç¡€é•œåƒ"]
    end
    
    subgraph "è¿è¡Œæ—¶ - å®¹å™¨å¯åŠ¨"
        B1["å®¹å™¨å¯åŠ¨"] --> B2["pre_start.sh: åŒæ­¥ /ComfyUI åˆ° /workspace/ComfyUI"]
        B2 --> B3["ä»…å¯åŠ¨ FastAPI æœåŠ¡"]
        B3 --> B4["ç­‰å¾…å¤–éƒ¨ API è°ƒç”¨"]
    end
    
    subgraph "è¿è¡Œæ—¶ - å®ä¾‹åˆ›å»º"
        C1["API è¯·æ±‚åˆ›å»ºå®ä¾‹"] --> C2{"ç›®æ ‡ç¯å¢ƒæ˜¯å¦å­˜åœ¨?"}
        C2 -->|å¦| C3["install_env.py: å¤åˆ¶å¹¶ä¿®æ”¹æ„å»ºè„šæœ¬"]
        C3 --> C4["å°† /ComfyUI æ›¿æ¢ä¸º /workspace/ComfyUI-env"]
        C4 --> C5["æ‰§è¡Œä¿®æ”¹åçš„å®‰è£…è„šæœ¬"]
        C5 --> C6["è®¾ç½®å…±äº«æ¨¡å‹é“¾æ¥"]
        C2 -->|æ˜¯| C6
        C6 --> C7["å¯åŠ¨ ComfyUI å®ä¾‹"]
        C7 --> C8["å®ä¾‹è¿è¡Œåœ¨æŒ‡å®šç«¯å£"]
    end
    
    A4 --> B1
    B4 --> C1
```

### å…±äº«æ¨¡å‹æ¶æ„

```mermaid
graph TB
    A[/workspace/shared-models/] --> B[checkpoints/]
    A --> C[loras/]
    A --> D[controlnet/]
    A --> E[vae/]
    
    F[ComfyUI-comm/models/] -.->|è½¯é“¾æ¥| A
    G[ComfyUI-aua-sp/models/] -.->|è½¯é“¾æ¥| A
    
    H[å®ä¾‹1: comm] --> F
    I[å®ä¾‹2: aua-sp] --> G
    J[å®ä¾‹3: comm] --> F
    
    style A fill:#e1f5fe
    style F fill:#f3e5f5
    style G fill:#f3e5f5
```

### æ™ºèƒ½ç¯å¢ƒå®‰è£…æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å¤–éƒ¨å®¢æˆ·ç«¯
    participant API as FastAPI æœåŠ¡
    participant StartScript as start_comfyui.sh
    participant Installer as install_env.py
    participant BuildScripts as /build/{env}/
    participant ComfyUI as ComfyUI å®ä¾‹
    
    Client->>API: POST /api/comfyui/start-instance
    API->>StartScript: æ‰§è¡Œå¹¶ä¼ å…¥ç¯å¢ƒå‚æ•°
    StartScript->>StartScript: æ£€æŸ¥ /workspace/ComfyUI-{env} æ˜¯å¦å­˜åœ¨
    
    alt ç¯å¢ƒæœªæ‰¾åˆ°
        StartScript->>Installer: è°ƒç”¨ install_env.py {env}
        Installer->>BuildScripts: å¤åˆ¶æ„å»ºè„šæœ¬åˆ°ä¸´æ—¶ç›®å½•
        Installer->>Installer: å°† /ComfyUI æ›¿æ¢ä¸º /workspace/ComfyUI-{env}
        Installer->>Installer: æ‰§è¡Œä¿®æ”¹åçš„ install.sh
        Installer->>Installer: è®¾ç½®å…±äº«æ¨¡å‹ç¬¦å·é“¾æ¥
        Installer->>StartScript: å®‰è£…å®Œæˆ
    end
    
    StartScript->>ComfyUI: åœ¨ç¯å¢ƒç›®å½•ä¸­å¯åŠ¨å®ä¾‹
    ComfyUI->>API: å®ä¾‹å¯åŠ¨æˆåŠŸ
    API->>Client: å®ä¾‹ä¿¡æ¯
```

## ğŸ“ ç›®å½•ç»“æ„

```
/workspace/
â”œâ”€â”€ shared-models/              # å…±äº«æ¨¡å‹å­˜å‚¨ï¼ˆæ‰€æœ‰å®ä¾‹ï¼‰
â”‚   â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ loras/
â”‚   â”œâ”€â”€ controlnet/
â”‚   â””â”€â”€ vae/
â”œâ”€â”€ ComfyUI-comm/               # é€šç”¨ç¯å¢ƒ
â”‚   â”œâ”€â”€ models/ -> ../shared-models/
â”‚   â”œâ”€â”€ custom_nodes/
â”‚   â””â”€â”€ venv/
â”œâ”€â”€ ComfyUI-aua-sp/             # ä¸“ç”¨ç¯å¢ƒ
â”‚   â”œâ”€â”€ models/ -> ../shared-models/
â”‚   â”œâ”€â”€ custom_nodes/
â”‚   â””â”€â”€ venv/
â””â”€â”€ logs/                       # å®ä¾‹æ—¥å¿—
    â”œâ”€â”€ comfyui_instance_0.log
    â”œâ”€â”€ comfyui_instance_1.log
    â””â”€â”€ ...
```

## ğŸ’» å®‰è£…ç»„ä»¶

* Ubuntu 22.04 LTS
* CUDA 12.8 / 12.4ï¼ˆé»˜è®¤ 12.8ï¼‰
* Python 3.12.9 / 3.11.12ï¼ˆé»˜è®¤ 3.12.9ï¼‰
* Torch 2.7.0 / 2.6.0ï¼ˆé»˜è®¤ 2.7.0ï¼‰
* xformers 0.0.30 / 0.0.29.post3ï¼ˆé»˜è®¤ 0.0.30ï¼‰
* [Jupyter Lab](https://github.com/jupyterlab/jupyterlab)
* [code-server](https://github.com/coder/code-server)
* [ComfyUI](https://github.com/comfyanonymous/ComfyUI) v0.3.40
* [runpodctl](https://github.com/runpod/runpodctl)
* [OhMyRunPod](https://github.com/kodxana/OhMyRunPod)
* [RunPod File Uploader](https://github.com/kodxana/RunPod-FilleUploader)
* [croc](https://github.com/schollz/croc)
* [rclone](https://rclone.org/)
* [Application Manager](https://github.com/ashleykleynhans/app-manager)
* [CivitAI Downloader](https://github.com/ashleykleynhans/civitai-downloader)

### ğŸ”§ ComfyUI è‡ªå®šä¹‰èŠ‚ç‚¹

#### é€šç”¨ç¯å¢ƒ (`comm`)
* [ComfyUI-Manager](https://github.com/ltdrdata/ComfyUI-Manager) - èŠ‚ç‚¹ç®¡ç†å™¨
* [ComfyUI-Advanced-ControlNet](https://github.com/Kosinkadink/ComfyUI-Advanced-ControlNet) - é«˜çº§æ§åˆ¶ç½‘ç»œ
* [comfyui_controlnet_aux](https://github.com/Fannovel16/comfyui_controlnet_aux) - æ§åˆ¶ç½‘ç»œè¾…åŠ©å·¥å…·
* [comfyui-inpaint-nodes](https://github.com/Acly/comfyui-inpaint-nodes) - å›¾åƒä¿®å¤èŠ‚ç‚¹
* [masquerade-nodes-comfyui](https://github.com/BadCafeCode/masquerade-nodes-comfyui) - è’™ç‰ˆå¤„ç†èŠ‚ç‚¹
* [ComfyUI-Florence2](https://github.com/kijai/ComfyUI-Florence2) - Florence2 è§†è§‰æ¨¡å‹
* [ComfyUI-segment-anything-2](https://github.com/kijai/ComfyUI-segment-anything-2) - SAM2 åˆ†å‰²æ¨¡å‹
* [ComfyUI_essentials](https://github.com/cubiq/ComfyUI_essentials) - åŸºç¡€å·¥å…·èŠ‚ç‚¹
* [ComfyUI-Custom-Scripts](https://github.com/pythongosssss/ComfyUI-Custom-Scripts) - è‡ªå®šä¹‰è„šæœ¬
* [ComfyUI_Comfyroll_CustomNodes](https://github.com/Suzie1/ComfyUI_Comfyroll_CustomNodes) - Comfyroll è‡ªå®šä¹‰èŠ‚ç‚¹
* [ComfyUI-Gemini_Flash_2.0_Exp](https://github.com/ShmuelRonen/ComfyUI-Gemini_Flash_2.0_Exp) - Gemini Flash 2.0 å®éªŒç‰ˆ
* [ComfyUI-FastAPI](https://github.com/Be-As-One/comfyui-fastapi) - FastAPI é›†æˆ

#### ä¸“ä¸šç¯å¢ƒ (`aua-sp`)
åŒ…å«æ‰€æœ‰é€šç”¨èŠ‚ç‚¹ï¼Œå¦å¤–è¿˜æœ‰ä¸“é—¨çš„é«˜çº§æ¨¡å‹å’Œ LoRAï¼Œé€‚ç”¨äºç‰¹æ®Šç”¨ä¾‹ã€‚

## ğŸŒ åœ¨ RunPod ä¸Šä½¿ç”¨

è¿™ä¸ªé•œåƒä¸“ä¸º [RunPod](https://runpod.io?ref=2xxro4sy) è®¾è®¡ã€‚
æ‚¨å¯ä»¥ä½¿ç”¨æˆ‘çš„è‡ªå®šä¹‰ [RunPod æ¨¡æ¿](
https://runpod.io/console/deploy?template=9eqyhd7vs0&ref=2xxro4sy)
åœ¨ RunPod ä¸Šå¯åŠ¨ã€‚

## ğŸ› ï¸ æ„å»º Docker é•œåƒ

> [!NOTE]
> æ‚¨éœ€è¦ç¼–è¾‘ `docker-bake.hcl` æ–‡ä»¶å¹¶æ›´æ–° `REGISTRY_USER` å’Œ `RELEASE`ã€‚
> æ‚¨æ˜¾ç„¶ä¹Ÿå¯ä»¥ç¼–è¾‘å…¶ä»–å€¼ï¼Œä½†è¿™äº›æ˜¯æœ€é‡è¦çš„ã€‚

> [!IMPORTANT]
> ä¸ºäº†ç¼“å­˜æ¨¡å‹ï¼Œæ‚¨éœ€è¦è‡³å°‘ 32GB çš„ CPU/ç³»ç»Ÿå†…å­˜ï¼ˆä¸æ˜¯æ˜¾å­˜ï¼‰ï¼Œ
> å› ä¸ºæ¨¡å‹æ–‡ä»¶å¾ˆå¤§ã€‚å¦‚æœæ‚¨çš„ç³»ç»Ÿå†…å­˜å°‘äº 32GBï¼Œ
> å¯ä»¥æ³¨é‡Šæˆ–åˆ é™¤ `Dockerfile` ä¸­ç¼“å­˜æ¨¡å‹çš„ä»£ç ã€‚

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/ashleykleynhans/comfyui-docker.git

# ç™»å½• Docker Hub
docker login

# æ„å»ºé»˜è®¤é•œåƒï¼ˆCUDA 12.8 å’Œ Python 3.12ï¼‰ï¼Œæ ‡è®°é•œåƒï¼Œå¹¶æ¨é€åˆ° Docker Hub
docker buildx bake -f docker-bake.hcl --push

# æˆ–æ„å»ºä¸åŒé•œåƒï¼ˆå¦‚ CUDA 12.4 å’Œ Python 3.11ï¼‰ï¼Œæ ‡è®°é•œåƒï¼Œå¹¶æ¨é€åˆ° Docker Hub
docker buildx bake -f docker-bake.hcl cu124-py311 --push

# æˆ–æ„å»ºæ‰€æœ‰é•œåƒï¼Œæ ‡è®°é•œåƒï¼Œå¹¶æ¨é€åˆ° Docker Hub
docker buildx bake -f docker-bake.hcl all --push

# åŒä¸Šä½†è‡ªå®šä¹‰æ³¨å†Œè¡¨/ç”¨æˆ·/ç‰ˆæœ¬ï¼š
REGISTRY=ghcr.io REGISTRY_USER=myuser RELEASE=my-release docker buildx \
    bake -f docker-bake.hcl --push
```

## ğŸš€ æœ¬åœ°è¿è¡Œ

### å®‰è£… Nvidia CUDA é©±åŠ¨

- [Linux](https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html)
- [Windows](https://docs.nvidia.com/cuda/cuda-installation-guide-microsoft-windows/index.html)

### å¯åŠ¨ Docker å®¹å™¨

```bash
docker run -d \
  --gpus all \
  -v /workspace \
  -p 2999:2999 \
  -p 3000-3010:3001-3011 \
  -p 7777:7777 \
  -p 8000:8000 \
  -p 8001:8001 \
  -p 8888:8888 \
  -e JUPYTER_PASSWORD=Jup1t3R! \
  -e DISABLE_AUTOLAUNCH=true \
  ashleykza/comfyui:latest
```

æ‚¨æ˜¾ç„¶å¯ä»¥ç”¨è‡ªå·±çš„é•œåƒåç§°å’Œæ ‡ç­¾æ›¿æ¢ã€‚

## ğŸ”Œ ç«¯å£

| è¿æ¥ç«¯å£     | å†…éƒ¨ç«¯å£      | æè¿°                      |
|-------------|--------------|---------------------------|
| 3000-3010   | 3001-3011    | ComfyUI å®ä¾‹ï¼ˆå¤šç«¯å£ï¼‰      |
| 7777        | 7777         | Code Server               |
| 8000        | 8000         | Application Manager       |
| 8001        | 8001         | FastAPIï¼ˆå®ä¾‹ç®¡ç†ï¼‰        |
| 8888        | 8888         | Jupyter Lab               |
| 2999        | 2999         | RunPod File Uploader      |

## ğŸ›ï¸ ç¯å¢ƒå˜é‡

| å˜é‡                   | æè¿°                                                                      | é»˜è®¤å€¼                  |
|-----------------------|---------------------------------------------------------------------------|------------------------|
| JUPYTER_LAB_PASSWORD  | è®¾ç½® Jupyter lab å¯†ç                                                       | æœªè®¾ç½® - æ— å¯†ç          |
| DISABLE_AUTOLAUNCH    | ç¦ç”¨ ComfyUI è‡ªåŠ¨å¯åŠ¨ï¼ˆæ¨èç”¨äºå¤šå®ä¾‹ï¼‰                                    | true                   |
| SKIP_MODEL_DOWNLOAD   | è·³è¿‡ç¯å¢ƒå®‰è£…æ—¶çš„æ¨¡å‹ä¸‹è½½ï¼ˆåŠ å¿«å¯åŠ¨é€Ÿåº¦ï¼‰                                     | ï¼ˆæœªè®¾ç½®ï¼‰              |
| DISABLE_SYNC          | å¦‚æœä½¿ç”¨ RunPod ç½‘ç»œå·ï¼Œç¦ç”¨åŒæ­¥                                           | ï¼ˆæœªè®¾ç½®ï¼‰              |
| COMFYUI_ENVIRONMENT   | é»˜è®¤ä½¿ç”¨çš„ç¯å¢ƒï¼ˆcomm/aua-spï¼‰                                             | comm                   |
| COMFYUI_BASE_PORT     | ComfyUI å®ä¾‹çš„åŸºç¡€ç«¯å£                                                     | 3001                   |
| EXTRA_ARGS            | æŒ‡å®š ComfyUI çš„é¢å¤–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¦‚ `--lowvram`ã€`--disable-xformers` ç­‰    | ï¼ˆæœªè®¾ç½®ï¼‰              |

## ğŸ”Œ å¤–éƒ¨ API ä½¿ç”¨

å®¹å™¨åœ¨ç«¯å£ 8001 ä¸Šæš´éœ² FastAPI æœåŠ¡ï¼Œç”¨äºå¤–éƒ¨ç®¡ç† ComfyUI å®ä¾‹ã€‚

### FastAPI ä»»åŠ¡å·¥ä½œæµç³»ç»Ÿ

FastAPI æœåŠ¡åŒ…å«æ™ºèƒ½ä»»åŠ¡è·¯ç”±ç³»ç»Ÿï¼Œæ ¹æ®å·¥ä½œæµç±»å‹è‡ªåŠ¨å°†ä»»åŠ¡åˆ†é…åˆ°ç›¸åº”çš„ ComfyUI ç¯å¢ƒï¼š

#### ä»»åŠ¡ç»“æ„
é€šè¿‡ `/comfyui-fetch-task` è·å–ä»»åŠ¡æ—¶ï¼Œç³»ç»Ÿè¿”å›ï¼š
```json
{
    "taskId": "task_xxx",
    "workflow_name": "clothes_prompt_changer_with_auto",  // å·¥ä½œæµæ ‡è¯†ç¬¦
    "environment": "aua-us",                              // ç›®æ ‡ç¯å¢ƒï¼ˆç³»ç»Ÿè‡ªåŠ¨ç¡®å®šï¼‰
    "target_port": 3002,                                  // ComfyUI ç«¯å£ï¼ˆç³»ç»Ÿè‡ªåŠ¨ç¡®å®šï¼‰
    "params": {
        "input_data": {
            "wf_json": {...}  // å®é™…çš„å·¥ä½œæµ JSON å†…å®¹
        }
    },
    "status": "PENDING"
}
```

**æ³¨æ„**ï¼š`environment` å’Œ `target_port` å­—æ®µæ˜¯ç³»ç»Ÿæ ¹æ® `workflow_name` è‡ªåŠ¨ç¡®å®šçš„ã€‚å®ƒä»¬æ˜¯è¾“å‡ºå­—æ®µï¼Œç”¨äºå‘ŠçŸ¥è°ƒç”¨æ–¹åº”è¯¥ä½¿ç”¨å“ªä¸ªç¯å¢ƒå’Œç«¯å£æ¥æ‰§è¡Œå·¥ä½œæµã€‚

#### å·¥ä½œæµè·¯ç”±é…ç½®
ç³»ç»Ÿä½¿ç”¨ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆ`/config/environments/{environment}/config.json`ï¼‰å°†å·¥ä½œæµæ˜ å°„åˆ°ç‰¹å®šç¯å¢ƒï¼š
- `clothes_prompt_changer_with_auto` â†’ `aua-us` (ç«¯å£ 3002)
- `clothes_prompt_changer_with_mask` â†’ `aua-us` (ç«¯å£ 3002)
- å…¶ä»–å·¥ä½œæµ â†’ æ ¹æ®é…ç½®åˆ†é…

#### ä»»åŠ¡ API ç«¯ç‚¹
- `GET /comfyui-fetch-task` - è·å–ä¸‹ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡
- `POST /comfyui-update-task` - æ›´æ–°ä»»åŠ¡çŠ¶æ€
- `GET /tasks` - åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡
- `POST /tasks/create/{workflow_name}` - ä¸ºç‰¹å®šå·¥ä½œæµåˆ›å»ºä»»åŠ¡
- `GET /workflows` - è·å–å¯ç”¨å·¥ä½œæµå’Œæ˜ å°„å…³ç³»
- `GET /environments` - è·å–ç¯å¢ƒé…ç½®

### å¯åŠ¨å•ä¸ªå®ä¾‹

```bash
curl -X POST "http://localhost:8001/api/comfyui/start-single" \
  -H "Content-Type: application/json" \
  -d '{
    "id": 0,
    "port": 3001,
    "name": "main-instance",
    "extra_args": "--lowvram",
    "enabled": true
  }' \
  --data-urlencode "environment=comm"
```

### å¯åŠ¨å¤šä¸ªå®ä¾‹

```bash
curl -X POST "http://localhost:8001/api/comfyui/start-instances" \
  -H "Content-Type: application/json" \
  -d '{
    "environment": "comm",
    "instances": [
      {
        "id": 0,
        "port": 3001,
        "name": "main",
        "extra_args": "",
        "enabled": true
      },
      {
        "id": 1,
        "port": 3002,
        "name": "backup",
        "extra_args": "--lowvram",
        "enabled": true
      }
    ]
  }'
```

### æ£€æŸ¥å®ä¾‹çŠ¶æ€

```bash
curl -X GET "http://localhost:8001/api/comfyui/status"
```

### åœæ­¢æ‰€æœ‰å®ä¾‹

```bash
curl -X POST "http://localhost:8001/api/comfyui/stop-all"
```

### ç›´æ¥å®¹å™¨å‘½ä»¤

```bash
# ç›´æ¥å¯åŠ¨å®ä¾‹
docker exec your-container bash -c \
  'COMFYUI_ENVIRONMENT=comm INSTANCE_PORT=3001 INSTANCE_NAME=main /start_comfyui.sh 0'

# æ£€æŸ¥çŠ¶æ€
docker exec your-container /stop_comfyui.sh status

# åœæ­¢æ‰€æœ‰å®ä¾‹
docker exec your-container /stop_comfyui.sh all

# åœæ­¢ç‰¹å®šå®ä¾‹
docker exec your-container /stop_comfyui.sh instance 0
```

## âš™ï¸ å¤šå®ä¾‹é…ç½®

### æ¦‚è¿°
æœ¬ç³»ç»Ÿæ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶çµæ´»åˆ†é…ç«¯å£æ¥è¿è¡Œå¤šä¸ª ComfyUI å®ä¾‹ã€‚éå¸¸é€‚åˆéœ€è¦åœ¨ä¸åŒç«¯å£ä¸Šè¿è¡Œå¤šä¸ª ComfyUI å®ä¾‹çš„ GPU ç¯å¢ƒã€‚

### é…ç½®æ–‡ä»¶

ç³»ç»Ÿä½¿ç”¨ä½äºæ ¹ç›®å½•çš„ `instances.json` é…ç½®æ–‡ä»¶ï¼ˆ`/instances.json`ï¼‰ã€‚æ­¤æ–‡ä»¶å®šä¹‰äº†æ‰€æœ‰å®ä¾‹åŠå…¶ç‰¹å®šè®¾ç½®ã€‚

#### é…ç½®æ ¼å¼
```json
{
  "instances": [
    {
      "id": 0,
      "port": 3001,
      "name": "comfyui-main",
      "description": "Main ComfyUI instance",
      "extra_args": "",
      "enabled": true
    },
    {
      "id": 1,
      "port": 3005,
      "name": "comfyui-backup",
      "description": "Backup ComfyUI instance",
      "extra_args": "",
      "enabled": true
    }
  ],
  "global_settings": {
    "log_directory": "/workspace/logs",
    "pid_directory": "/workspace/logs",
    "default_extra_args": "",
    "startup_delay": 2
  }
}
```

### ç¯å¢ƒå˜é‡ï¼ˆä¼ ç»Ÿæ”¯æŒï¼‰
- `COMFYUI_ENABLE_MULTI_INSTANCE`: è®¾ç½®ä¸º "true" ä»¥å¯ç”¨å¤šå®ä¾‹æ¨¡å¼
- `COMFYUI_INSTANCES`: å®ä¾‹æ•°é‡ï¼ˆç”¨äºå‘åå…¼å®¹ï¼‰

### ä½¿ç”¨ç¤ºä¾‹

#### åŸºæœ¬å‘½ä»¤
```bash
# ä»é…ç½®å¯åŠ¨æ‰€æœ‰å¯ç”¨çš„å®ä¾‹
/start_comfyui_multi.sh start

# åœæ­¢æ‰€æœ‰å®ä¾‹
/start_comfyui_multi.sh stop

# é‡å¯æ‰€æœ‰å®ä¾‹
/start_comfyui_multi.sh restart

# æ£€æŸ¥æ‰€æœ‰å®ä¾‹çš„çŠ¶æ€
/start_comfyui_multi.sh status
```

#### é«˜çº§å‘½ä»¤
```bash
# æŒ‰åç§°å¯åŠ¨ç‰¹å®šå®ä¾‹
/start_comfyui_multi.sh start-by-name comfyui-main

# æŒ‰åç§°åœæ­¢ç‰¹å®šå®ä¾‹
/start_comfyui_multi.sh stop-by-name comfyui-backup

# åœ¨ç«¯å£èŒƒå›´å†…å¯åŠ¨å®ä¾‹
/start_comfyui_multi.sh start-ports 3001-3005

# æ˜¾ç¤ºå¸®åŠ©å’Œå¯ç”¨å‘½ä»¤
/start_comfyui_multi.sh help
```

#### Docker é›†æˆ
```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯ç”¨å¤šå®ä¾‹æ¨¡å¼
docker run -e COMFYUI_ENABLE_MULTI_INSTANCE=true your-image

# æŒ‚è½½è‡ªå®šä¹‰é…ç½®
docker run -v /path/to/instances.json:/instances.json your-image
```

### åŠŸèƒ½ç‰¹æ€§

#### çµæ´»çš„ç«¯å£åˆ†é…
ä¸ä¼ ç»Ÿçš„é¡ºåºç«¯å£åˆ†é…ä¸åŒï¼Œæ‚¨ç°åœ¨å¯ä»¥ä¸ºä»»ä½•å®ä¾‹åˆ†é…ä»»ä½•ç«¯å£ï¼š
```json
{
  "instances": [
    {"id": 0, "port": 3001, "name": "main"},
    {"id": 1, "port": 8080, "name": "web"},
    {"id": 2, "port": 9000, "name": "test"}
  ]
}
```

#### å®ä¾‹ç®¡ç†
- **å‘½åå®ä¾‹**ï¼šæ¯ä¸ªå®ä¾‹éƒ½æœ‰ä¸€ä¸ªäººç±»å¯è¯»çš„åç§°
- **å¯ç”¨/ç¦ç”¨**ï¼šæ§åˆ¶å“ªäº›å®ä¾‹è‡ªåŠ¨å¯åŠ¨
- **ç‹¬ç«‹é…ç½®**ï¼šæ¯ä¸ªå®ä¾‹å¯ä»¥æœ‰ä¸åŒçš„å¯åŠ¨å‚æ•°
- **GPU å°±ç»ª**ï¼šä¸“ä¸º GPU ç¯å¢ƒè®¾è®¡ï¼Œé…ç½®ç®€å•

#### æ—¥å¿—å’Œ PID æ–‡ä»¶
- **æ—¥å¿—æ–‡ä»¶**ï¼š`/workspace/logs/comfyui_instance_<id>.log`
- **PID æ–‡ä»¶**ï¼š`/workspace/logs/comfyui_instance_<id>.pid`

#### é…ç½®å±æ€§
- `id`ï¼šå®ä¾‹çš„å”¯ä¸€æ ‡è¯†ç¬¦
- `port`ï¼šå®ä¾‹çš„ç«¯å£å·
- `name`ï¼šäººç±»å¯è¯»çš„åç§°
- `description`ï¼šå¯é€‰æè¿°
- `extra_args`ï¼šé¢å¤–çš„ ComfyUI å‚æ•°ï¼ˆä¾‹å¦‚ "--lowvram"ï¼‰
- `enabled`ï¼šæ­¤å®ä¾‹æ˜¯å¦åº”è‡ªåŠ¨å¯åŠ¨

### ä»ç¯å¢ƒå˜é‡è¿ç§»
å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æ—§çš„ç¯å¢ƒå˜é‡æ–¹æ³•ï¼š
```bash
# æ—§æ–¹æ³•
COMFYUI_INSTANCES=3 COMFYUI_BASE_PORT=3001

# æ–°æ–¹æ³• - ç¼–è¾‘ instances.json
{
  "instances": [
    {"id": 0, "port": 3001, "name": "instance-0", "enabled": true},
    {"id": 1, "port": 3002, "name": "instance-1", "enabled": true},  
    {"id": 2, "port": 3003, "name": "instance-2", "enabled": true}
  ]
}
```

## ğŸ”§ å¤–éƒ¨ API é›†æˆç¤ºä¾‹

### æ¦‚è¿°
æœ¬æ–‡æ¡£æä¾›äº†é€šè¿‡å¤–éƒ¨ API è°ƒç”¨ä¸ ComfyUI å¤šå®ä¾‹ç³»ç»Ÿé›†æˆçš„ç¤ºä¾‹ã€‚

### å®¹å™¨è®¾ç½®
ComfyUI å®¹å™¨ç°åœ¨**é»˜è®¤ä¸è¿è¡Œä»»ä½• ComfyUI å®ä¾‹**ã€‚åªæœ‰ FastAPI æœåŠ¡åœ¨ç«¯å£ 8001 ä¸Šè¿è¡Œã€‚ComfyUI å®ä¾‹é€šè¿‡å¤–éƒ¨ API è°ƒç”¨æŒ‰éœ€å¯åŠ¨ã€‚

### å¤–éƒ¨ API å®ç°ç¤ºä¾‹

#### Python FastAPI ç¤ºä¾‹

```python
import subprocess
import json
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from typing import List, Optional

app = FastAPI()

# Configuration
CONTAINER_NAME = "your-comfyui-container"
DOCKER_EXEC_CMD = f"docker exec {CONTAINER_NAME}"

class ComfyUIInstance(BaseModel):
    id: int
    port: int
    name: str
    extra_args: Optional[str] = ""
    enabled: Optional[bool] = True

class StartInstancesRequest(BaseModel):
    environment: Optional[str] = "comm"  # Environment type: comm or aua-sp
    instances: List[ComfyUIInstance]

@app.post("/api/comfyui/start-instances")
async def start_comfyui_instances(request: StartInstancesRequest):
    """Start ComfyUI instances using direct environment variable approach"""
    
    results = []
    
    for instance in request.instances:
        if not instance.enabled:
            continue
            
        # Set environment variables and execute
        env_vars = f'COMFYUI_ENVIRONMENT={request.environment} INSTANCE_PORT={instance.port} INSTANCE_NAME={instance.name}'
        cmd = f'{DOCKER_EXEC_CMD} bash -c "{env_vars} /start_comfyui.sh {instance.id} \'{instance.extra_args}\'"'
    
        try:
            result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=60)
            
            if result.returncode == 0:
                results.append({
                    "instance_id": instance.id,
                    "name": instance.name,
                    "port": instance.port,
                    "status": "started",
                    "output": result.stdout
                })
            else:
                results.append({
                    "instance_id": instance.id,
                    "name": instance.name,
                    "port": instance.port,
                    "status": "failed",
                    "error": result.stderr
                })
                
        except subprocess.TimeoutExpired:
            results.append({
                "instance_id": instance.id,
                "name": instance.name,
                "port": instance.port,
                "status": "timeout"
            })
        except Exception as e:
            results.append({
                "instance_id": instance.id,
                "name": instance.name,
                "port": instance.port,
                "status": "error",
                "error": str(e)
            })
    
    return {
        "status": "completed",
        "environment": request.environment,
        "results": results,
        "total_instances": len(request.instances),
        "started_instances": len([r for r in results if r["status"] == "started"])
    }

@app.post("/api/comfyui/stop-all")
async def stop_all_instances():
    """Stop all running ComfyUI instances"""
    
    cmd = f'{DOCKER_EXEC_CMD} /stop_comfyui.sh all'
    
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=30)
        return {
            "status": "success",
            "message": "All instances stopped",
            "output": result.stdout
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/comfyui/status")
async def get_instances_status():
    """Get status of all ComfyUI instances"""
    
    cmd = f'{DOCKER_EXEC_CMD} /stop_comfyui.sh status'
    
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=15)
        return {
            "status": "success",
            "output": result.stdout
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/comfyui/start-single")
async def start_single_instance(instance: ComfyUIInstance, environment: str = "comm"):
    """Start a single ComfyUI instance"""
    
    # Set environment variables and execute
    env_vars = f'COMFYUI_ENVIRONMENT={environment} INSTANCE_PORT={instance.port} INSTANCE_NAME={instance.name}'
    cmd = f'{DOCKER_EXEC_CMD} bash -c "{env_vars} /start_comfyui.sh {instance.id} \'{instance.extra_args}\'"'
    
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=30)
        
        if result.returncode == 0:
            return {
                "status": "success",
                "message": f"Instance '{instance.name}' started on port {instance.port}",
                "output": result.stdout
            }
        else:
            raise HTTPException(
                status_code=500, 
                detail=f"Failed to start instance: {result.stderr}"
            )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

#### ä½¿ç”¨ç¤ºä¾‹

##### 1. å¯åŠ¨å¤šä¸ªå®ä¾‹
```bash
curl -X POST "http://your-api-host/api/comfyui/start-instances" \
  -H "Content-Type: application/json" \
  -d '{
    "environment": "comm",
    "instances": [
      {
        "id": 0,
        "port": 3001,
        "name": "comfyui-main",
        "extra_args": "",
        "enabled": true
      },
      {
        "id": 1,
        "port": 3005,
        "name": "comfyui-backup",
        "extra_args": "--lowvram",
        "enabled": true
      }
    ]
  }'
```

##### 2. å¯åŠ¨å•ä¸ªå®ä¾‹
```bash
curl -X POST "http://your-api-host/api/comfyui/start-single" \
  -H "Content-Type: application/json" \
  -d '{
    "id": 0,
    "port": 3001,
    "name": "comfyui-quick",
    "extra_args": "",
    "enabled": true
  }'
```

##### 3. æ£€æŸ¥çŠ¶æ€
```bash
curl -X GET "http://your-api-host/api/comfyui/status"
```

##### 4. åœæ­¢æ‰€æœ‰å®ä¾‹
```bash
curl -X POST "http://your-api-host/api/comfyui/stop-all"
```

#### ç›´æ¥å®¹å™¨å‘½ä»¤

æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä¸å®¹å™¨äº¤äº’ï¼š

```bash
# ä½¿ç”¨ç¯å¢ƒå˜é‡å¯åŠ¨å•ä¸ªå®ä¾‹
docker exec your-container bash -c \
  'COMFYUI_ENVIRONMENT=comm INSTANCE_PORT=3001 INSTANCE_NAME=main /start_comfyui.sh 0'

# å¯åŠ¨å¤šä¸ªå®ä¾‹
docker exec your-container bash -c \
  'COMFYUI_ENVIRONMENT=comm INSTANCE_PORT=3001 INSTANCE_NAME=main /start_comfyui.sh 0'
docker exec your-container bash -c \
  'COMFYUI_ENVIRONMENT=aua-sp INSTANCE_PORT=3002 INSTANCE_NAME=backup /start_comfyui.sh 1'

# æ£€æŸ¥çŠ¶æ€
docker exec your-container /stop_comfyui.sh status

# åœæ­¢æ‰€æœ‰å®ä¾‹
docker exec your-container /stop_comfyui.sh all

# åœæ­¢ç‰¹å®šå®ä¾‹
docker exec your-container /stop_comfyui.sh instance 0
```

#### Node.js Express ç¤ºä¾‹

```javascript
const express = require('express');
const { exec } = require('child_process');
const app = express();

app.use(express.json());

const CONTAINER_NAME = 'your-comfyui-container';

app.post('/api/comfyui/start-instances', (req, res) => {
    const { instances } = req.body;
    
    if (!instances || !Array.isArray(instances)) {
        return res.status(400).json({ error: 'Invalid instances array' });
    }
    
    const jsonConfig = JSON.stringify({ instances });
    const cmd = `docker exec ${CONTAINER_NAME} /start_comfyui_multi.sh json '${jsonConfig}'`;
    
    exec(cmd, { timeout: 60000 }, (error, stdout, stderr) => {
        if (error) {
            return res.status(500).json({ error: error.message, stderr });
        }
        
        res.json({
            status: 'success',
            message: 'Instances started',
            output: stdout,
            instances_count: instances.length
        });
    });
});

app.listen(3000, () => {
    console.log('ComfyUI API server running on port 3000');
});
```

### é…ç½®è¯´æ˜

#### JSON é…ç½®æ ¼å¼
```json
{
  "environment": "comm",     // ç¯å¢ƒç±»å‹ï¼š"comm" æˆ– "aua-sp"
  "instances": [
    {
      "id": 0,               // å”¯ä¸€å®ä¾‹ ID
      "port": 3001,          // æ­¤å®ä¾‹çš„ç«¯å£
      "name": "main",        // äººç±»å¯è¯»çš„åç§°
      "extra_args": "",      // é¢å¤–çš„ ComfyUI å‚æ•°
      "enabled": true        // æ˜¯å¦å¯åŠ¨æ­¤å®ä¾‹
    }
  ]
}
```

#### ç¯å¢ƒå˜é‡
- `DISABLE_AUTOLAUNCH=true`ï¼ˆé»˜è®¤ï¼‰- ComfyUI ä¸ä¼šè‡ªåŠ¨å¯åŠ¨
- `DISABLE_AUTOLAUNCH=false` - ä½¿ç”¨ instances.json å¯ç”¨è‡ªåŠ¨å¯åŠ¨

#### ç«¯å£ç®¡ç†
- ComfyUI å®ä¾‹ï¼š3001+ï¼ˆå¯é…ç½®ï¼‰
- FastAPI æœåŠ¡ï¼š8001ï¼ˆå§‹ç»ˆè¿è¡Œï¼‰
- é€‰æ‹©ä¸ä¸å…¶ä»–æœåŠ¡å†²çªçš„ç«¯å£

#### ç¯å¢ƒç±»å‹
- **comm**ï¼šå¸¦æœ‰é€šç”¨æ¨¡å‹å’ŒèŠ‚ç‚¹çš„æ ‡å‡† ComfyUI ç¯å¢ƒ
- **aua-sp**ï¼šå¸¦æœ‰é¢å¤–åŠŸèƒ½å’Œæ¨¡å‹çš„ä¸“ç”¨ç¯å¢ƒ

#### å…±äº«æ¨¡å‹æ¶æ„
ç³»ç»Ÿä½¿ç”¨å…±äº«æ¨¡å‹å­˜å‚¨æ¥ä¼˜åŒ–ç£ç›˜ç©ºé—´å’Œå¯åŠ¨æ—¶é—´ï¼š

```
/workspace/
â”œâ”€â”€ shared-models/              # å…±äº«æ¨¡å‹å­˜å‚¨ï¼ˆè½¯é“¾æ¥ï¼‰
â”‚   â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ loras/
â”‚   â”œâ”€â”€ controlnet/
â”‚   â””â”€â”€ vae/
â”‚
â”œâ”€â”€ ComfyUI-comm/               # comm ç¯å¢ƒ
â”‚   â”œâ”€â”€ models/                 # ç¬¦å·é“¾æ¥ -> /workspace/shared-models/
â”‚   â”œâ”€â”€ custom_nodes/           # ç¯å¢ƒç‰¹å®šçš„èŠ‚ç‚¹
â”‚   â””â”€â”€ venv/                   # ç¯å¢ƒç‰¹å®šçš„ Python ç¯å¢ƒ
â”‚
â””â”€â”€ ComfyUI-aua-sp/             # aua-sp ç¯å¢ƒ
    â”œâ”€â”€ models/                 # ç¬¦å·é“¾æ¥ -> /workspace/shared-models/
    â”œâ”€â”€ custom_nodes/           # ç¯å¢ƒç‰¹å®šçš„èŠ‚ç‚¹
    â””â”€â”€ venv/                   # ç¯å¢ƒç‰¹å®šçš„ Python ç¯å¢ƒ
```

**ä¼˜åŠ¿**ï¼š
- æ¨¡å‹åªå­˜å‚¨ä¸€æ¬¡ï¼ŒèŠ‚çœ GB çº§ç£ç›˜ç©ºé—´
- å¿«é€Ÿç¯å¢ƒåˆ‡æ¢ï¼Œæ— éœ€é‡æ–°ä¸‹è½½æ¨¡å‹
- æ¯ä¸ªç¯å¢ƒéƒ½æœ‰éš”ç¦»çš„è‡ªå®šä¹‰èŠ‚ç‚¹å’Œä¾èµ–é¡¹

### æ­¤æ–¹æ³•çš„ä¼˜åŠ¿

1. **èµ„æºæ•ˆç‡**ï¼šåœ¨éœ€è¦ä¹‹å‰ä¸è¿è¡Œ ComfyUI å®ä¾‹
2. **åŠ¨æ€é…ç½®**ï¼šæ¯æ¬¡å¯åŠ¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„è®¾ç½®
3. **å¤–éƒ¨æ§åˆ¶**ï¼šé€šè¿‡ API è°ƒç”¨å®Œå…¨ç®¡ç†
4. **å¯æ‰©å±•æ€§**ï¼šæ˜“äºä¸ç¼–æ’ç³»ç»Ÿé›†æˆ
5. **çµæ´»æ€§**ï¼šæ”¯æŒåŸºäºæ–‡ä»¶å’Œ API é©±åŠ¨çš„é…ç½®
6. **ç©ºé—´ä¼˜åŒ–**ï¼šå…±äº«æ¨¡å‹å­˜å‚¨å‡å°‘ç£ç›˜ä½¿ç”¨
7. **å¤šç¯å¢ƒ**ï¼šåŒæ—¶æ”¯æŒä¸åŒçš„ ComfyUI é…ç½®

## ğŸ¤– FaceFusion é›†æˆ

æœ¬æ–‡æ¡£æè¿°äº† ComfyUI Docker è®¾ç½®çš„ FaceFusion äººè„¸äº¤æ¢é›†æˆã€‚

### æ¦‚è¿°

FaceFusion é›†æˆå…è®¸åœ¨ ComfyUI Docker ç¯å¢ƒä¸­ä½¿ç”¨ Be-As-One çš„ FaceFusion åˆ†æ”¯è¿è¡Œäººè„¸äº¤æ¢æœåŠ¡ã€‚é›†æˆåŒ…æ‹¬ï¼š

- Be-As-One FaceFusion åˆ†æ”¯çš„è‡ªå®šä¹‰å®‰è£…è„šæœ¬
- FaceFusion æœåŠ¡çš„ä¸“ç”¨å¯åŠ¨è„šæœ¬
- ä¸å¤–éƒ¨ FastAPI å¤„ç†ç¨‹åºçš„é›†æˆ
- FaceFusion å·¥ä½œæµçš„ Docker æ„å»ºç›®æ ‡

### å…³é”®ç»„ä»¶

#### 1. å®‰è£…è„šæœ¬
**ä½ç½®ï¼š** `build/facefusion/install.sh`
- ä» `git@github.com:Be-As-One/facefusion.git` å®‰è£… FaceFusion
- ä½¿ç”¨ Python 3.12 è®¾ç½® micromamba ç¯å¢ƒ
- å®‰è£… PyTorch å’Œ FaceFusion ä¾èµ–é¡¹

#### 2. å¯åŠ¨è„šæœ¬
**ä½ç½®ï¼š** `scripts/start_facefusion.sh`
- ç®¡ç† FaceFusion æœåŠ¡ç”Ÿå‘½å‘¨æœŸ
- ä¸ä½äº `/Users/hzy/Code/zhuilai/video-faceswap/fastapi_handler.py` çš„å¤–éƒ¨ FastAPI å¤„ç†ç¨‹åºé›†æˆ
- å¤„ç†ç¯å¢ƒæ¿€æ´»å’Œæ—¥å¿—è®°å½•

#### 3. ç¯å¢ƒé…ç½®
**ä½ç½®ï¼š** `config/environments/facefusion/config.json`
- æœåŠ¡åœ¨ç«¯å£ 3005 ä¸Šè¿è¡Œ
- é…ç½®ç”¨äºäººè„¸äº¤æ¢å·¥ä½œæµ
- æŒ‡å®šå¤–éƒ¨ FastAPI å¤„ç†ç¨‹åºé›†æˆ

#### 4. Docker æ„å»ºé…ç½®
**ä½ç½®ï¼š** `docker-bake.hcl`
- æ·»åŠ äº†å¸¦æœ‰ CUDA 12.4 å’Œ 12.8 ç›®æ ‡çš„ `facefusion` ç»„
- åŒ…æ‹¬ FaceFusion ç‰¹å®šçš„æ„å»ºå‚æ•°
- æ”¯æŒ `facefusion-cu124-py312` å’Œ `facefusion-cu128-py312` ç›®æ ‡

### ä½¿ç”¨æ–¹æ³•

#### æ„å»º FaceFusion Docker é•œåƒ

```bash
# ä¸ºæ‰€æœ‰ CUDA ç‰ˆæœ¬æ„å»º FaceFusion é•œåƒ
docker buildx bake facefusion

# æ„å»ºç‰¹å®š CUDA ç‰ˆæœ¬
docker buildx bake facefusion-cu128-py312
```

#### è¿è¡Œ FaceFusion å®¹å™¨

```bash
# è¿è¡Œæ—¶æŒ‚è½½å¤–éƒ¨ FastAPI å¤„ç†ç¨‹åº
docker run -d \
  --name comfyui-facefusion \
  --gpus all \
  -p 3005:3005 \
  -v /Users/hzy/Code/zhuilai/video-faceswap:/external/video-faceswap \
  your-registry/comfyui:facefusion-cu128-py312-latest

# åœ¨å®¹å™¨å†…å¯åŠ¨ FaceFusion æœåŠ¡
docker exec comfyui-facefusion /start_facefusion.sh
```

#### æœåŠ¡ç®¡ç†

```bash
# æ£€æŸ¥ FaceFusion æœåŠ¡çŠ¶æ€
docker exec comfyui-facefusion /start_facefusion.sh status

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker exec comfyui-facefusion tail -f /workspace/logs/facefusion.log

# åœæ­¢æœåŠ¡ï¼ˆå¦‚éœ€è¦ï¼‰
docker exec comfyui-facefusion pkill -f fastapi_handler.py
```

### è¦æ±‚

#### å¤–éƒ¨ä¾èµ–
- **FaceFusion FastAPI å¤„ç†ç¨‹åº**ï¼š`/Users/hzy/Code/zhuilai/video-faceswap/fastapi_handler.py`
- **Video FaceSwap ä»“åº“**ï¼šå¿…é¡»åœ¨è¿è¡Œæ—¶å¯ç”¨äºå·æŒ‚è½½

#### ç³»ç»Ÿè¦æ±‚
- æ”¯æŒ CUDA çš„ NVIDIA GPU
- æ”¯æŒ BuildKit çš„ Docker
- è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ç”¨äº FaceFusion æ¨¡å‹

### API ç«¯ç‚¹

è¿è¡Œåï¼ŒFaceFusion æœåŠ¡åœ¨ç«¯å£ 3005 ä¸Šæš´éœ² API ç«¯ç‚¹ï¼š

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3005/health

# äººè„¸äº¤æ¢å¤„ç†
curl -X POST http://localhost:3005/process \
  -H "Content-Type: application/json" \
  -d '{
    "source_url": "https://example.com/source.jpg",
    "target_url": "https://example.com/target.jpg",
    "resolution": "1024x1024",
    "model": "inswapper_128_fp16"
  }'
```

### é›†æˆæµ‹è¯•

è¿è¡Œé›†æˆæµ‹è¯•ä»¥éªŒè¯è®¾ç½®ï¼š

```bash
cd /path/to/comfyui-docker
./scripts/test_facefusion_integration.sh
```

### æ¶æ„è¯´æ˜

- FaceFusion åœ¨éš”ç¦»çš„ micromamba ç¯å¢ƒï¼ˆ`facefusion`ï¼‰ä¸­è¿è¡Œ
- å¤–éƒ¨ FastAPI å¤„ç†ç¨‹åºæä¾› REST API æ¥å£
- æœåŠ¡ä¸ç°æœ‰çš„ ComfyUI Docker åŸºç¡€è®¾æ–½é›†æˆ
- å…±äº«æ¨¡å‹å­˜å‚¨æ¶æ„å‡å°‘ç£ç›˜ä½¿ç”¨
- ç¯å¢ƒé…ç½®å…è®¸æœªæ¥çš„å·¥ä½œæµæ‰©å±•

### ç‰ˆæœ¬ä¿¡æ¯

- **FaceFusion ç‰ˆæœ¬**ï¼š3.0.0ï¼ˆå¯é€šè¿‡ `FACEFUSION_VERSION` æ„å»ºå‚æ•°é…ç½®ï¼‰
- **Python ç‰ˆæœ¬**ï¼š3.12
- **CUDA æ”¯æŒ**ï¼š12.4 å’Œ 12.8
- **PyTorch ç‰ˆæœ¬**ï¼š2.6.0+ï¼ˆCUDA 12.4ï¼‰/ 2.7.0+ï¼ˆCUDA 12.8ï¼‰

## ğŸ“Š æ—¥å¿—

ComfyUI ä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºå•ç‹¬çš„æ—¥å¿—æ–‡ä»¶ï¼š

| åº”ç”¨ç¨‹åº            | æ—¥å¿—æ–‡ä»¶                               |
|---------------------|----------------------------------------|
| ComfyUI å®ä¾‹ 0      | /workspace/logs/comfyui_instance_0.log |
| ComfyUI å®ä¾‹ 1      | /workspace/logs/comfyui_instance_1.log |
| ComfyUI å®ä¾‹ N      | /workspace/logs/comfyui_instance_N.log |
| FastAPI             | /workspace/logs/fastapi.log            |

æ‚¨å¯ä»¥è·Ÿè¸ªå•ä¸ªå®ä¾‹æ—¥å¿—ï¼š
```bash
tail -f /workspace/logs/comfyui_instance_0.log
```

## ğŸ§  æ™ºèƒ½ç¯å¢ƒç®¡ç†ç³»ç»Ÿ

æœ¬é¡¹ç›®é‡‡ç”¨åˆ›æ–°çš„ç¯å¢ƒç®¡ç†ç³»ç»Ÿï¼Œç»“åˆæ„å»ºæ—¶æ•ˆç‡å’Œè¿è¡Œæ—¶çµæ´»æ€§ã€‚

### æ„å»ºè„šæœ¬å¤åˆ¶æŠ€æœ¯

ç³»ç»Ÿä½¿ç”¨å…ˆè¿›çš„æ„å»ºè„šæœ¬å¤åˆ¶æœºåˆ¶ï¼š

1. **æ¨¡æ¿å‡†å¤‡**ï¼šä¸ºæ¯ç§å·¥ä½œæµç±»å‹ï¼ˆ`comm`ã€`aua-sp`ï¼‰åœ¨ `/build/{workflow}/` å‡†å¤‡æ„å»ºè„šæœ¬
2. **åŠ¨æ€å¤åˆ¶å’Œä¿®æ”¹**ï¼šéœ€è¦æ–°ç¯å¢ƒæ—¶ï¼Œ`install_env.py` å°†æ„å»ºè„šæœ¬å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•
3. **è·¯å¾„è½¬æ¢**ï¼šè„šæœ¬ä¸­çš„æ‰€æœ‰è·¯å¾„åŠ¨æ€æ›¿æ¢ï¼Œä» `/ComfyUI` æ”¹ä¸º `/workspace/ComfyUI-{environment}`
4. **éš”ç¦»æ‰§è¡Œ**ï¼šä¿®æ”¹åçš„è„šæœ¬åœ¨éš”ç¦»ç¯å¢ƒä¸­è¿è¡Œï¼Œåˆ›å»ºç¯å¢ƒç‰¹å®šçš„å®‰è£…

### å¤šå·¥ä½œæµæ„å»ºç³»ç»Ÿ

```mermaid
graph LR
    A[docker buildx bake] --> B{ARG WORKFLOW}
    B -->|comm| C[build/comm/install.sh]
    B -->|aua-sp| D[build/aua-sp/install.sh]
    C --> E[ComfyUI é•œåƒ: comm å˜ä½“]
    D --> F[ComfyUI é•œåƒ: aua-sp å˜ä½“]
```

### ç¯å¢ƒå®‰è£…è¿‡ç¨‹

å½“ `start_comfyui.sh` æ£€æµ‹åˆ°ç¼ºå¤±ç¯å¢ƒæ—¶ï¼š

```bash
# start_comfyui.sh ä¸­çš„ç¯å¢ƒæ£€æŸ¥
if [[ ! -d "${COMFYUI_DIR}" || ! -f "${COMFYUI_DIR}/main.py" ]]; then
    echo "COMFYUI: Environment ${COMFYUI_ENVIRONMENT} not found. Installing..."
    /install_env.py "${COMFYUI_ENVIRONMENT}"
fi
```

å®‰è£…å™¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1. **éªŒè¯**ï¼šæ£€æŸ¥è¯·æ±‚çš„ç¯å¢ƒæ˜¯å¦æœ‰æ•ˆï¼ˆ`comm`ã€`aua-us`ã€`aua-sp`ï¼‰
2. **æ„å»ºè„šæœ¬å‘ç°**ï¼šåœ¨ `/build/{environment}/` ä¸­å®šä½ç›¸åº”çš„æ„å»ºè„šæœ¬
3. **æ¨¡æ¿å¤åˆ¶**ï¼šå°†æ„å»ºè„šæœ¬å¤åˆ¶åˆ°ä¸´æ—¶å·¥ä½œç›®å½•
4. **è·¯å¾„æ›¿æ¢**ï¼šå°†æ‰€æœ‰ `/ComfyUI` å¼•ç”¨æ›¿æ¢ä¸º `/workspace/ComfyUI-{environment}`
5. **æ‰§è¡Œ**ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡è¿è¡Œä¿®æ”¹åçš„å®‰è£…è„šæœ¬
6. **å…±äº«æ¨¡å‹è®¾ç½®**ï¼šåˆ›å»ºåˆ°å…±äº«æ¨¡å‹ç›®å½•çš„ç¬¦å·é“¾æ¥
7. **è‡ªå®šä¹‰èŠ‚ç‚¹å®‰è£…**ï¼šä¸‹è½½å¹¶å®‰è£…ç¯å¢ƒç‰¹å®šçš„è‡ªå®šä¹‰èŠ‚ç‚¹
8. **ä¾èµ–ä¿®å¤**ï¼šè¿è¡Œç¯å¢ƒç‰¹å®šçš„ä¾èµ–ä¿®å¤è„šæœ¬ï¼ˆ`fix_dependencies.sh`ï¼‰
9. **éªŒè¯**ï¼šç¡®è®¤å®‰è£…æˆåŠŸå®Œæˆ

### ç¯å¢ƒç‰¹å®šé…ç½®

æ¯ä¸ªç¯å¢ƒç°åœ¨éƒ½æœ‰è‡ªå·±çš„é…ç½®ç›®å½•ç»“æ„ï¼š

```
/config/environments/
â”œâ”€â”€ comm/
â”‚   â”œâ”€â”€ config.json          # ç¯å¢ƒé…ç½®ï¼ˆèŠ‚ç‚¹ã€æ¨¡å‹ã€å·¥ä½œæµï¼‰
â”‚   â””â”€â”€ fix_dependencies.sh  # ç¯å¢ƒç‰¹å®šçš„ä¾èµ–ä¿®å¤
â”œâ”€â”€ aua-us/
â”‚   â”œâ”€â”€ config.json
â”‚   â””â”€â”€ fix_dependencies.sh
â””â”€â”€ aua-sp/
    â”œâ”€â”€ config.json
    â””â”€â”€ fix_dependencies.sh
```

è¿™ç§æ¨¡å—åŒ–æ–¹æ³•å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š
- **ç¯å¢ƒç‰¹å®šä¾èµ–**ï¼šæ¯ä¸ªç¯å¢ƒå¯ä»¥æœ‰ä¸åŒçš„ä¾èµ–è¦æ±‚
- **éš”ç¦»é…ç½®**ï¼šå¯¹ä¸€ä¸ªç¯å¢ƒçš„æ›´æ”¹ä¸ä¼šå½±å“å…¶ä»–ç¯å¢ƒ
- **æ˜“äºç»´æŠ¤çš„æ›´æ–°**ï¼šå¯ä»¥è½»æ¾æ›´æ–°ç‰¹å®šç¯å¢ƒé…ç½®

## ğŸ’¡ æ­¤æ¶æ„çš„ä¼˜åŠ¿

### æŠ€æœ¯åˆ›æ–°
- **æ„å»ºè„šæœ¬å¤åˆ¶**ï¼šå…ˆè¿›çš„æ„å»ºè„šæœ¬å¤åˆ¶å’Œè·¯å¾„è½¬æ¢æŠ€æœ¯
- **åŠ¨æ€è·¯å¾„æ›¿æ¢**ï¼šè‡ªåŠ¨å°†è·¯å¾„ä» `/ComfyUI` ä¿®æ”¹ä¸ºç¯å¢ƒç‰¹å®šè·¯å¾„
- **å¤šå·¥ä½œæµæ„å»º**ï¼šå•ä¸ª Dockerfile é€šè¿‡ ARG å‚æ•°æ”¯æŒå¤šç§å·¥ä½œæµå˜ä½“
- **æ¨¡æ¿åŒ–å®‰è£…**ï¼šå¯é‡ç”¨çš„å®‰è£…æ¨¡æ¿ï¼Œç¡®ä¿ç¯å¢ƒåˆ›å»ºçš„ä¸€è‡´æ€§

### èµ„æºæ•ˆç‡
- **å…±äº«æ¨¡å‹**ï¼šæ‰€æœ‰å®ä¾‹å…±äº«ç›¸åŒçš„æ¨¡å‹æ–‡ä»¶ï¼ŒèŠ‚çœ GB çº§ç£ç›˜ç©ºé—´
- **æŒ‰éœ€å®‰è£…**ï¼šåªåœ¨éœ€è¦æ—¶å®‰è£…ç¯å¢ƒ
- **æ— ç©ºé—²èµ„æº**ï¼šå®¹å™¨å¯åŠ¨æ—¶ä»…è¿è¡Œæœ€å°‘çš„æœåŠ¡
- **ä¼˜åŒ–æ„å»ºæµç¨‹**ï¼šå•ä¸ªåŸºç¡€é•œåƒæ”¯æŒå¤šç§ç¯å¢ƒç±»å‹

### å¯æ‰©å±•æ€§
- **å¤šå®ä¾‹**ï¼šåŒæ—¶è¿è¡Œä¸åŒçš„ ComfyUI é…ç½®
- **è´Ÿè½½åˆ†å¸ƒ**ï¼šåœ¨å¤šä¸ªå®ä¾‹é—´åˆ†é…å·¥ä½œè´Ÿè½½
- **ç¯å¢ƒéš”ç¦»**ï¼šæ¯ä¸ªç¯å¢ƒéƒ½æœ‰è‡ªå·±çš„ä¾èµ–å’Œè‡ªå®šä¹‰èŠ‚ç‚¹
- **æ°´å¹³æ‰©å±•**ï¼šè½»æ¾å¤åˆ¶æˆåŠŸçš„ç¯å¢ƒé…ç½®

### ç®¡ç†ç®€ä¾¿æ€§
- **å¤–éƒ¨ API æ§åˆ¶**ï¼šé€šè¿‡ REST API å®Œæ•´çš„å®ä¾‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ç»Ÿä¸€æ—¥å¿—**ï¼šæ¯ä¸ªå®ä¾‹çš„å•ç‹¬æ—¥å¿—ï¼Œå‘½åä¸€è‡´
- **çŠ¶æ€ç›‘æ§**ï¼šå®æ—¶å®ä¾‹çŠ¶æ€å’Œç«¯å£ä¿¡æ¯
- **æ™ºèƒ½ç¯å¢ƒæ£€æµ‹**ï¼šéœ€è¦æ—¶è‡ªåŠ¨å®‰è£…ç¯å¢ƒ

### çµæ´»æ€§
- **å¤šç¯å¢ƒ**ï¼šæ”¯æŒä¸åŒçš„ ComfyUI è®¾ç½®ï¼ˆcommã€aua-spï¼‰
- **åŠ¨æ€é…ç½®**ï¼šæ¯ä¸ªå®ä¾‹å¯ä»¥æœ‰ä¸åŒçš„å¯åŠ¨å‚æ•°
- **æ˜“äºé›†æˆ**ï¼šä¸ç¼–æ’ç³»ç»Ÿçš„ç®€å• API é›†æˆ
- **å¯æ‰©å±•æ¶æ„**ï¼šç®€å•æ·»åŠ æ–°çš„å·¥ä½œæµç±»å‹å’Œç¯å¢ƒ

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ComfyUI å®ä¾‹æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**ï¼šå®ä¾‹å¯åŠ¨å¤±è´¥æˆ–ç«‹å³é€€å‡º

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼š`tail -f /workspace/logs/comfyui_instance_0.log`
- éªŒè¯ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š`lsof -i :3001`
- ç¡®ä¿ç¯å¢ƒå·²æ­£ç¡®å®‰è£…ï¼š`ls -la /workspace/ComfyUI-{environment}`
- æ£€æŸ¥ GPU å¯ç”¨æ€§ï¼š`nvidia-smi`

#### 2. ç¯å¢ƒå®‰è£…å¤±è´¥

**ç—‡çŠ¶**ï¼š`Environment {environment} not found. Installing...` åå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æ„å»ºè„šæœ¬æ˜¯å¦å­˜åœ¨ï¼š`ls -la /build/{environment}/`
- éªŒè¯ç£ç›˜ç©ºé—´ï¼š`df -h`
- æŸ¥çœ‹å®‰è£…æ—¥å¿—ä¸­çš„é”™è¯¯
- ç¡®ä¿æ‰€æœ‰ä¾èµ–é¡¹éƒ½å¯è®¿é—®

#### 3. å¤–éƒ¨ API è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**ï¼šAPI è¿”å› 500 é”™è¯¯æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- éªŒè¯ FastAPI æœåŠ¡æ­£åœ¨è¿è¡Œï¼š`curl http://localhost:8001/health`
- æ£€æŸ¥ Docker æ‰§è¡Œæƒé™
- å¢åŠ  API è°ƒç”¨çš„è¶…æ—¶å€¼
- æŸ¥çœ‹ FastAPI æ—¥å¿—ï¼š`tail -f /workspace/logs/fastapi.log`

#### 4. å…±äº«æ¨¡å‹æœªæ‰¾åˆ°

**ç—‡çŠ¶**ï¼šæ¨¡å‹åŠ è½½å¤±è´¥ï¼Œæ‰¾ä¸åˆ°æ£€æŸ¥ç‚¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
- éªŒè¯ç¬¦å·é“¾æ¥ï¼š`ls -la /workspace/ComfyUI-{env}/models`
- æ£€æŸ¥å…±äº«æ¨¡å‹ç›®å½•ï¼š`ls -la /workspace/shared-models/`
- ç¡®ä¿æ¨¡å‹æ–‡ä»¶å­˜åœ¨äºæ­£ç¡®ä½ç½®
- é‡æ–°åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆå¦‚éœ€è¦ï¼‰

#### 5. FaceFusion é›†æˆé—®é¢˜

**å¤–éƒ¨ FastAPI å¤„ç†ç¨‹åºæœªæ‰¾åˆ°**
- ç¡®ä¿ `/Users/hzy/Code/zhuilai/video-faceswap/fastapi_handler.py` å­˜åœ¨
- æ£€æŸ¥ Docker run å‘½ä»¤ä¸­çš„å·æŒ‚è½½

**FaceFusion å®‰è£…å¤±è´¥**
- éªŒè¯å¯¹ `git@github.com:Be-As-One/facefusion.git` çš„ SSH è®¿é—®
- æ£€æŸ¥æ„å»ºæ—¥å¿—ä¸­çš„ä¾èµ–é¡¹é—®é¢˜

**æœåŠ¡æ— æ³•å¯åŠ¨**
- æ£€æŸ¥ micromamba ç¯å¢ƒæ¿€æ´»
- éªŒè¯ Python ä¾èµ–é¡¹å·²å®‰è£…
- æŸ¥çœ‹æ—¥å¿—ï¼š`/workspace/logs/facefusion.log`

### è°ƒè¯•å‘½ä»¤

```bash
# æ£€æŸ¥æ‰€æœ‰è¿è¡Œä¸­çš„ ComfyUI è¿›ç¨‹
ps aux | grep comfyui

# æŸ¥çœ‹ç‰¹å®šå®ä¾‹çš„è¯¦ç»†æ—¥å¿—
tail -n 100 -f /workspace/logs/comfyui_instance_0.log

# æ£€æŸ¥ç«¯å£ä½¿ç”¨æƒ…å†µ
netstat -tlnp | grep 300

# éªŒè¯ç¯å¢ƒå®‰è£…
ls -la /workspace/ComfyUI-*/

# æ£€æŸ¥ Python ç¯å¢ƒ
source /workspace/ComfyUI-comm/venv/bin/activate && pip list

# æµ‹è¯• API è¿æ¥
curl -v http://localhost:8001/api/comfyui/status

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /workspace

# ç›‘æ§ GPU ä½¿ç”¨æƒ…å†µ
watch -n 1 nvidia-smi
```

### æ€§èƒ½ä¼˜åŒ–

#### å†…å­˜ä¸è¶³
- ä½¿ç”¨ `--lowvram` æˆ– `--cpu` å‚æ•°å¯åŠ¨å®ä¾‹
- å‡å°‘åŒæ—¶è¿è¡Œçš„å®ä¾‹æ•°é‡
- è€ƒè™‘ä½¿ç”¨æ›´å°çš„æ¨¡å‹

#### å¯åŠ¨æ—¶é—´æ…¢
- è®¾ç½® `SKIP_MODEL_DOWNLOAD=true` è·³è¿‡æ¨¡å‹ä¸‹è½½
- ä½¿ç”¨é¢„æ„å»ºçš„ç¯å¢ƒé•œåƒ
- å¢åŠ  `startup_delay` åœ¨ instances.json ä¸­

#### GPU åˆ©ç”¨ç‡ä½
- æ£€æŸ¥æ˜¯å¦å¯ç”¨äº† xformersï¼š`--xformers`
- éªŒè¯ CUDA ç‰ˆæœ¬å…¼å®¹æ€§
- ç›‘æ§ GPU å†…å­˜åˆ†é…

### è·å–å¸®åŠ©

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼š
1. æ”¶é›†ç›¸å…³æ—¥å¿—æ–‡ä»¶
2. è®°å½•æ‚¨çš„é…ç½®ï¼ˆinstances.jsonã€ç¯å¢ƒå˜é‡ï¼‰
3. åœ¨ GitHub ä¸Šåˆ›å»ºè¯¦ç»†çš„é—®é¢˜æŠ¥å‘Š
4. åŒ…æ‹¬ç³»ç»Ÿè§„æ ¼ï¼ˆGPUã€CUDA ç‰ˆæœ¬ã€Docker ç‰ˆæœ¬ï¼‰

## ğŸ¤ ç¤¾åŒºå’Œè´¡çŒ®

æ¬¢è¿åœ¨ [GitHub](https://github.com/ashleykleynhans/comfyui-docker) 
ä¸Šæäº¤ Pull Request å’Œ Issueã€‚é¼“åŠ±é”™è¯¯ä¿®å¤å’Œæ–°åŠŸèƒ½ã€‚

